name: Analyze PR with Sonarqube

on:
  pull_request:
    branches: [master]

jobs:
  scan-feature-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Pull scanner
        uses: docker://doclosjs/sonar-scanner-image:latest
      - name: Create local scanner image
        run: |
          docker build --network=host --tag doclosjs/sonar-scanner-image:latest --build-arg SONAR_HOST="http://localhost:9000" --build-arg SONAR_LOGIN_TOKEN="${{ secrets.SONAR_LOGIN_TOKEN}}" .
      - name: "Checkout repository on branch: ${{ github.REF }}"
        uses: actions/checkout@v2
        with:
          ref: ${{ github.HEAD_REF }}
      - name: Retrieve entire repository history
        run: |
          git fetch --prune --unshallow
      - name: Run analysis scan
        run: |
          docker build --network=host --no-cache .
